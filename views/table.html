<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin="anonymous" />
    <title>Book Table</title>
    <link rel="stylesheet" href="/css/table.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?version=3.52.1&features=fetch"></script>
    <script src="https://js.stripe.com/v3/"></script>
</head>

<body>
    <section class="banner">
        <h2>BOOK YOUR TABLE </h2>
        <div class="card-content">
            <h3>Enter your details</h3>
            <div class="form">
                <div class="form-row">
                    <input type="text" name="firstName" class="firstName" placeholder="First Name">
                    <input type="text" name="lastName" class="lastName" placeholder="Last Name">
                </div>
                <div class="form-row">
                    <input type="email" name="email" class="email" placeholder="Email">
                    <select name="persons" class="persons" id="persons">
                        <option value="1" selected>1 Person</option>
                        <option value="2">2 Persons</option>
                        <option value="3">3 Persons</option>
                        <option value="4">4 Persons</option>
                        <option value="5">5 Persons</option>
                        <option value="6">6 Persons</option>
                    </select>
                </div>
                <div class="form-row">
                    <input type="date" name="date" class="date" placeholder="Enter date of arrival!">
                    <select name="time" class="time" id="time">
                        <option value="10">10 A.M - 11 A.M</option>
                        <option value="11">11 A.M - 12 P.M</option>
                        <option value="12">12 P.M - 1 P.M</option>
                        <option value="13">1 P.M - 2 P.M</option>
                        <option value="14">2 P.M - 3 P.M</option>
                        <option value="15">3 P.M - 4 P.M</option>
                        <option value="16">4 P.M - 5 P.M</option>
                        <option value="17">5 P.M - 6 P.M</option>
                        <option value="18">6 P.M - 7 P.M</option>
                        <option value="19">7 P.M - 8 P.M</option>
                        <option value="20">8 P.M - 9 P.M</option>
                        <option value="21">9 P.M - 10 P.M</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-error-message">
                    </div>
                </div>

                <div class="form-row">
                    <p class="cost">Total Amount: Rs. <span></span></p>
                    <input type="submit" id="submit" onclick="return validation()" value="BOOK TABLE">
                </div>
            </div>
        </div>
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous"></script>
    <script>
        setInterval(() => {
            document.querySelector('.cost span').innerHTML = parseInt(document.querySelector("#persons").value) * 50;
        }, 10)

        async function validation() {
            // First Name
            if (!$('.firstName')[0].value) {
                $('.form-error-message')[0].classList += " error";
                $('.form-error-message')[0].innerHTML = "Enter First Name";
                return false;
            } else if (!isNaN($('.firstName')[0])) {
                $('.form-error-message')[0].classList += " error";
                $('.form-error-message')[0].innerHTML = "Enter a valid First Name";
                return false;
            } else {
                $('.form-error-message')[0].classList.remove("error");
            }

            // Last Name
            if (!$('.lastName')[0].value) {
                $('.form-error-message')[0].classList += " error";
                $('.form-error-message')[0].innerHTML = "Enter Last Name";
                return false;
            } else if (!isNaN($('.lastName')[0])) {
                $('.form-error-message')[0].classList += " error";
                $('.form-error-message')[0].innerHTML = "Enter a valid Last Name";
                return false;
            } else {
                $('.form-error-message')[0].classList.remove("error");
            }

            // Email
            if ($(".email")[0].value == "") {
                $('.form-error-message')[0].classList.add("error");
                $('.form-error-message')[0].innerHTML = "Enter Email";
                return false;
            } else {
                $('.form-error-message')[0].classList.remove("error");
            }

            if ($('.date')[0].value == "") {
                $('.form-error-message')[0].classList.add("error");
                $('.form-error-message')[0].innerHTML = "Enter Date";
                return false;
            } else if (new Date() > new Date($(".date")[0].value)) {
                $('.form-error-message')[0].classList.add("error");
                $('.form-error-message')[0].innerHTML = "Date must be greater than current date";
                return false;
            } else if ((new Date().getMonth() == new Date($(".date")[0].value).getMonth()) && (new Date().getYear() == new Date($(".date")[0].value).getYear()) && (new Date().getDate() == new Date($(".date")[0].value).getDate())) {
                if (new Date().getHours() - $(".time")[0].value < 2) {
                    $('.form-error-message')[0].classList.add("error");
                    $('.form-error-message')[0].innerHTML = "Time must be greater than current date";
                    return false;
                }
            }

            var _tableDetails1 = false;
            await fetch('/tableDetails/' + document.querySelector(".date").value + '/' + document.querySelector(".time").value, {
                    method: "GET",
                })
                .then(function(result) {
                    return result.json();
                })
                .then(function(json) {
                    var tableDetails = json;
                    return tableDetails.table;
                }).then((tableDetails) => {
                    if (tableDetails == 20) {
                        _tableDetails1 = true;
                        return false;
                    }
                });
            if (_tableDetails1) {
                $('.form-error-message')[0].classList.add("error");
                $('.form-error-message')[0].innerHTML = "All tables are reserved for this duration. Please select another time";
                return false;
            }

            var stripe = Stripe("pk_test_51ICkQ3Koy0nW0rNuHrLUZfbvh3eFsFrUUTVgGGavttDTvEhYPzEgXmrAyXPKk1F3lkcOARhpO3W3o9H35e2miMCY00FbaM4Jha");
            fetch("/create-checkout-session", {
                    method: "POST",
                    headers: {
                        "Content-type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify({
                        productName: "Book A Table",
                        images: ["https://upload.wikimedia.org/wikipedia/commons/f/fe/Traditional_Naivedya_thali.jpg"],
                        quantity: $('.persons')[0].value,
                        amount: 5000,
                        success_url: `http://localhost:3000/saveTables?firstName=${$('.firstName')[0].value}&lastName=${$('.lastName')[0].value}&date=${$('.date')[0].value}&persons=${$('.persons')[0].value}&email=${$('.email')[0].value}&time=${$('.time')[0].value}`
                    }),
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(session) {

                    return stripe.redirectToCheckout({
                        sessionId: session.id
                    });
                })
                .then(function(result) {
                    if (result.error) {
                        alert(result.error.message);
                    }
                })
                .catch(function(error) {
                    console.log("Error: ", error);
                });
        }
    </script>
</body>

</html>